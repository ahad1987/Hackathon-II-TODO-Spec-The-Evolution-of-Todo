---
# Phase V: Dapr Pub/Sub Component - SUBSCRIBERS ONLY
# Services that SUBSCRIBE to Kafka events (with consumer group initialization)
# Scoped to: recurring-processor, reminder-service, notification-service, audit-logger

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: taskflow-pubsub
  namespace: default
  labels:
    app: taskflow
    phase: phase-v
    role: subscriber
spec:
  type: pubsub.kafka
  version: v1
  metadata:
  # Kafka broker addresses (docker-compose service DNS)
  - name: brokers
    value: "kafka:29092"

  # Consumer group ID for Dapr subscribers
  - name: consumerGroup
    value: "taskflow-consumers"

  # Authentication (disabled for local development)
  - name: authRequired
    value: "false"

  # Topic configuration
  - name: maxMessageBytes
    value: "1048576"  # 1MB max message size

  # Consumer configuration
  - name: consumeRetryInterval
    value: "200ms"
  - name: consumeRetryEnabled
    value: "true"

  # Producer configuration
  - name: producerIdempotent
    value: "true"  # Enable idempotent producer (exactly-once semantics)
  - name: producerMaxRetries
    value: "3"

  # Client ID for Dapr
  - name: clientID
    value: "dapr-pubsub-subscribers"

  # Version (Kafka protocol version)
  - name: version
    value: "2.8.0"
# Component Scoping: ONLY services that subscribe to events
# Prevents backend from initializing Kafka consumers
scopes:
- recurring-processor
- reminder-service
- notification-service
- audit-logger

---
# Phase V: Dapr Pub/Sub Component - BACKEND PUBLISHER ONLY
# Backend publishes events but does NOT subscribe (NO consumer group initialization)
# This prevents "kafka: tried to use a consumer group that was closed" errors

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: taskflow-pubsub-publisher
  namespace: default
  labels:
    app: taskflow
    phase: phase-v
    role: publisher
spec:
  type: pubsub.kafka
  version: v1
  metadata:
  # Kafka broker addresses (docker-compose service DNS)
  - name: brokers
    value: "kafka:29092"

  # NO consumerGroup - backend does NOT subscribe to any events

  # Authentication (disabled for local development)
  - name: authRequired
    value: "false"

  # Topic configuration
  - name: maxMessageBytes
    value: "1048576"  # 1MB max message size

  # Producer configuration (publishing only)
  - name: producerIdempotent
    value: "true"  # Enable idempotent producer (exactly-once semantics)
  - name: producerMaxRetries
    value: "3"

  # Client ID for Dapr
  - name: clientID
    value: "dapr-pubsub-backend-publisher"

  # Version (Kafka protocol version)
  - name: version
    value: "2.8.0"
# Component Scoping: ONLY backend (publish-only, no subscriptions)
scopes:
- backend
- chat-api

---
# Phase V: Dapr Pub/Sub Subscriptions
# Defines which services subscribe to which topics
# All subscriptions reference "taskflow-pubsub" (the subscriber component)

# Subscription: Recurring Task Processor -> task.created events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: recurring-processor-task-created
  namespace: default
  labels:
    app: recurring-processor
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.created
  routes:
    default: /dapr/subscribe/task-created
  metadata:
    rawPayload: "false"  # Dapr wraps messages in CloudEvent format

---
# Subscription: Recurring Task Processor -> task.updated events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: recurring-processor-task-updated
  namespace: default
  labels:
    app: recurring-processor
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.updated
  routes:
    default: /dapr/subscribe/task-updated
  metadata:
    rawPayload: "false"

---
# Subscription: Reminder Service -> task.created events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: reminder-service-task-created
  namespace: default
  labels:
    app: reminder-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.created
  routes:
    default: /dapr/subscribe/task-created
  metadata:
    rawPayload: "false"

---
# Subscription: Reminder Service -> task.updated events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: reminder-service-task-updated
  namespace: default
  labels:
    app: reminder-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.updated
  routes:
    default: /dapr/subscribe/task-updated
  metadata:
    rawPayload: "false"

---
# Subscription: Reminder Service -> task.deleted events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: reminder-service-task-deleted
  namespace: default
  labels:
    app: reminder-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.deleted
  routes:
    default: /dapr/subscribe/task-deleted
  metadata:
    rawPayload: "false"

---
# Subscription: Notification Service -> task.created events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: notification-service-task-created
  namespace: default
  labels:
    app: notification-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.created
  routes:
    default: /dapr/subscribe/task-created
  metadata:
    rawPayload: "false"

---
# Subscription: Notification Service -> task.updated events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: notification-service-task-updated
  namespace: default
  labels:
    app: notification-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.updated
  routes:
    default: /dapr/subscribe/task-updated
  metadata:
    rawPayload: "false"

---
# Subscription: Notification Service -> task.completed events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: notification-service-task-completed
  namespace: default
  labels:
    app: notification-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.completed
  routes:
    default: /dapr/subscribe/task-completed
  metadata:
    rawPayload: "false"

---
# Subscription: Notification Service -> reminder-triggered events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: notification-service-reminder-triggered
  namespace: default
  labels:
    app: notification-service
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.reminder-triggered
  routes:
    default: /dapr/subscribe/reminder-triggered
  metadata:
    rawPayload: "false"

---
# Subscription: Audit Logger -> ALL task events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: audit-logger-task-created
  namespace: default
  labels:
    app: audit-logger
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.created
  routes:
    default: /dapr/subscribe/task-created
  metadata:
    rawPayload: "false"

---
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: audit-logger-task-updated
  namespace: default
  labels:
    app: audit-logger
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.updated
  routes:
    default: /dapr/subscribe/task-updated
  metadata:
    rawPayload: "false"

---
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: audit-logger-task-completed
  namespace: default
  labels:
    app: audit-logger
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.completed
  routes:
    default: /dapr/subscribe/task-completed
  metadata:
    rawPayload: "false"

---
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: audit-logger-task-deleted
  namespace: default
  labels:
    app: audit-logger
    phase: phase-v
spec:
  pubsubname: taskflow-pubsub
  topic: taskflow.tasks.deleted
  routes:
    default: /dapr/subscribe/task-deleted
  metadata:
    rawPayload: "false"
