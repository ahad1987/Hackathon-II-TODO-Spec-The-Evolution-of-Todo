---
# Phase V: Chat API Deployment with Dapr Sidecar
# Constitutional Compliance: Chat API is the ONLY producer of task events (Principle VII)
# Dapr annotations enable automatic sidecar injection for event publishing

apiVersion: v1
kind: ConfigMap
metadata:
  name: chat-api-config
  namespace: default
  labels:
    app: chat-api
    phase: phase-v
data:
  # Application configuration
  API_TITLE: "Todo API"
  API_VERSION: "0.1.0"
  ENVIRONMENT: "production"
  DEBUG: "false"

  # Dapr configuration (Phase V)
  DAPR_ENABLED: "true"
  DAPR_HTTP_PORT: "3500"
  DAPR_GRPC_PORT: "50001"
  PUBSUB_NAME: "taskflow-pubsub-publisher"

  # CORS configuration (stable localhost URLs for Minikube tunnel)
  CORS_ORIGINS: "http://127.0.0.1:3000,http://localhost:3000,https://mytodoappv2.vercel.app,https://stately-dieffenbachia-b565a9.netlify.app,https://taskflow-ai-chatbot.vercel.app"

---
# Secret for sensitive configuration (JWT secret, database credentials)
apiVersion: v1
kind: Secret
metadata:
  name: chat-api-secrets
  namespace: default
  labels:
    app: chat-api
    phase: phase-v
type: Opaque
stringData:
  # JWT secret (should be replaced with actual secret in production)
  BETTER_AUTH_SECRET: "your-very-long-secret-key-at-least-32-characters-for-jwt-signing-phase-ii-todo"

  # Database URL (should be replaced with actual database URL in production)
  DATABASE_URL: "postgresql://postgres:postgres@postgres.default.svc.cluster.local:5432/todo_db"

---
# Chat API Service (LoadBalancer for external access)
apiVersion: v1
kind: Service
metadata:
  name: chat-api
  namespace: default
  labels:
    app: chat-api
    phase: phase-v
spec:
  type: LoadBalancer
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: chat-api

---
# Chat API Deployment with Dapr Sidecar
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chat-api
  namespace: default
  labels:
    app: chat-api
    phase: phase-v
spec:
  replicas: 1  # Single replica for local development
  selector:
    matchLabels:
      app: chat-api
  template:
    metadata:
      labels:
        app: chat-api
      annotations:
        # Phase V: Dapr Sidecar Annotations (T022)
        # These annotations enable Dapr sidecar injection
        dapr.io/enabled: "true"                    # Enable Dapr sidecar
        dapr.io/app-id: "chat-api"                 # Dapr app ID for service invocation
        dapr.io/app-port: "8000"                   # Application HTTP port
        dapr.io/app-protocol: "http"               # Application protocol
        dapr.io/log-level: "info"                  # Dapr sidecar log level
        dapr.io/sidecar-cpu-limit: "500m"          # CPU limit for sidecar
        dapr.io/sidecar-memory-limit: "512Mi"      # Memory limit for sidecar
        dapr.io/sidecar-cpu-request: "100m"        # CPU request for sidecar
        dapr.io/sidecar-memory-request: "256Mi"    # Memory request for sidecar
        dapr.io/enable-metrics: "true"             # Enable Dapr metrics
        dapr.io/metrics-port: "9090"               # Dapr metrics port

    spec:
      containers:
      - name: chat-api
        image: phase-ii-backend:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP

        env:
        # Application configuration from ConfigMap
        - name: API_TITLE
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: API_TITLE
        - name: API_VERSION
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: API_VERSION
        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: ENVIRONMENT
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: DEBUG

        # Phase V: Dapr configuration from ConfigMap
        - name: DAPR_ENABLED
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: DAPR_ENABLED
        - name: DAPR_HTTP_PORT
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: DAPR_HTTP_PORT
        - name: DAPR_GRPC_PORT
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: DAPR_GRPC_PORT
        - name: PUBSUB_NAME
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: PUBSUB_NAME

        # CORS configuration from ConfigMap
        - name: CORS_ORIGINS
          valueFrom:
            configMapKeyRef:
              name: chat-api-config
              key: CORS_ORIGINS

        # Sensitive configuration from Secret
        - name: BETTER_AUTH_SECRET
          valueFrom:
            secretKeyRef:
              name: chat-api-secrets
              key: BETTER_AUTH_SECRET
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: chat-api-secrets
              key: DATABASE_URL
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: taskflow-anthropic-secret
              key: ANTHROPIC_API_KEY
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: taskflow-redis-secret
              key: REDIS_URL

        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "1000m"

        # Phase V: Liveness probe (process alive check)
        livenessProbe:
          httpGet:
            path: /health/live
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1

        # Phase V: Readiness probe (dependency health check)
        readinessProbe:
          httpGet:
            path: /health/live
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1

        # Startup probe (allows slow-starting containers)
        startupProbe:
          httpGet:
            path: /health/live
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 12  # 60 seconds total (12 * 5s)
          successThreshold: 1

---
# Horizontal Pod Autoscaler (optional, for production scaling)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: chat-api-hpa
  namespace: default
  labels:
    app: chat-api
    phase: phase-v
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: chat-api
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5 minutes
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
